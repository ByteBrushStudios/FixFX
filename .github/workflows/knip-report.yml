name: Knip Report

on:
  pull_request:

jobs:
  knip-report:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      
      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Build application
        run: bun run build

      - name: Generate Knip Report
        id: knip-report
        run: |
          {
            echo "## ðŸ“‹ Knip Analysis Report"
            echo ""
            echo "### Exports"
            bunx knip:exports 2>&1 || true
            echo ""
            echo "### Files"
            bunx knip:files 2>&1 || true
            echo ""
            echo "### Production"
            bunx knip:prod 2>&1 || true
          } >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "## ðŸ“‹ Knip Code Quality Analysis\n\nThis report identifies potentially unused exports, dependencies, and files. **Note:** These are warnings only and may contain false positives, especially for:\n- MDX/documentation components\n- Dynamic imports\n- Framework magic (Next.js, Fumadocs)\n\n### Summary\n- Only **hard fails** occur for unused dependencies (knip:deps)\n- All other checks are informational warnings\n\nTo run locally:\n- `bun run knip:deps` - Check unused dependencies (hard fail)\n- `bun run knip:exports` - Check unused exports (warning)\n- `bun run knip:files` - Check unused files (warning)\n- `bun run knip:prod` - Check production deps (warning)\n\nSee [Knip Documentation](https://knip.dev) for more details."
            })
